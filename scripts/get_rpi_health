#!/usr/bin/env python3

import paho.mqtt.client as mqtt
from subprocess import check_output
from re import findall
import json
import psutil

silent = True

def get_cpu_temp():

    temp = check_output(["cat", "/sys/class/thermal/thermal_zone0/temp"])

    return(float(temp)/1000)

def get_cpu_percent():

    cpu_percent = float(psutil.cpu_percent())

    return cpu_percent
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
def get_memory_percent():                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    memory = psutil.virtual_memory()                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    return float(memory.percent)                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
def get_gpu_temp():                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    temp = check_output(["vcgencmd", "measure_temp"]).decode("UTF-8")                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    return(float(findall("\d+\.\d+", temp)[0]))                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
def get_disk_percent():                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    disk = psutil.disk_usage("/")                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    return float(disk.percent)                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
def publish_message(topic, message):                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    if not silent:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
        print("Publishing to MQTT topic: " + topic)                                                                                                                                                                                                                                                                                                                                                                                                                                                    
        print("Message: " + message)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    broker_adress = "localhost"                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
    client = mqtt.Client("client")                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    client.connect(broker_adress, port=1883)                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    client.publish(topic, message)                                                                                                                                                                                                                                                                                                                                                                                                                                                                     

data = {"gpu_temp":       get_gpu_temp(),
        "cpu_temp":       get_cpu_temp(),
        "cpu_percent":    get_cpu_percent(),
        "memory_percent": get_memory_percent(),
        "disk_percent":   get_disk_percent()}

publish_message("tardis/rpi_health", json.dumps(data))
